const LBi = window.LBi || {};
LBi.weatherInfo = {};

LBi.greeting = (function ($) {
  const unicorns = [
    {
      min: "65",
      word: "toasty",
      images: [
        "assets/img/toastyA.png",
        "assets/img/toastyB.png",
        "assets/img/toastyC.png",
      ],
      clothe: "a breezy tee and sunglasses.",
    },
    {
      min: "45",
      word: "chilly",
      images: [
        "assets/img/chillyA.png",
        "assets/img/chillyB.png",
        "assets/img/chillyC.png",
      ],
      clothe: "a cozy sweater and earmuffs.",
    },
    {
      min: "25",
      word: "Brisk",
      images: [
        "assets/img/briskA.png",
        "assets/img/briskB.png",
        "assets/img/briskC.png",
      ],
      clothe: "a puffy vest and knit hat.",
    },
    {
      min: "0",
      word: "ice",
      images: [
        "assets/img/iceA.png",
        "assets/img/iceB.png",
        "assets/img/iceC.png",
      ],
      clothe: "a wintry parka and furry boots.",
    },
    {
      min: "null",
      word: "generic",
      images: [
        "assets/img/genericA.png",
        "assets/img/genericB.png",
        "assets/img/genericC.png",
        "assets/img/genericD.png",
        "assets/img/genericE.png",
        "assets/img/genericF.png",
      ],
      clothe: "a festive suit or a figure skating outfit.",
      messages: [
        "Since it’s the holiday season, your Unicorn is wearing a festive ensemble that razzles and dazzles.",
        "Since it’s the holiday season, your Unicorn is wearing a festive ensemble that sparkles and shines.",
        "Since it’s the holiday season, your Unicorn is wearing a festive ensemble that’s bold and wonderful.",
      ],
    },
  ];

  const getWeather = function () {
    navigator.geolocation.getCurrentPosition(
      function geoSuccess(position) {
        const lat = position.coords.latitude;
        const long = position.coords.longitude;
        getLocation(lat, long);
      },
      function geoError(code) {
        displayInfo("null");
      }
    );
  };

  const getLocation = function (lat, long) {
    const key = "97c6b1a26629f816b5a6695dff8087b9";
    const units = "imperial";
    const url = `http://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${long}&appid=${key}&units=${units}`;

    $.get(url, function (data) {
      displayInfo(data);
    });
  };

  const getRandomIndex = function (dataArray) {
    const max = dataArray.length;
    const random = Math.floor(Math.random() * Math.floor(max));
    return dataArray[random];
  };

  const getUnicorn = function (temp) {
    const unicorn = unicorns.find(function (element) {
      if (temp == element.min && temp == "null") {
        return true;
      } else {
        return temp >= element.min && temp != "null";
      }
    });
    return unicorn;
  };

  const displayInfo = function (data) {
    const temp = data == "null" ? data : data.main.temp;
    // console.log(data.main.temp);

    const myUnicorn = getUnicorn(temp);
    // console.log("temp: ", temp, " myUnicorn: ", myUnicorn);

    if (myUnicorn.messages) {
      $(".js-message-holder").html(getRandomIndex(myUnicorn.messages));
    }
    $(".js-image-holder").attr("src", getRandomIndex(myUnicorn.images));
    $(".js-info-word").html(myUnicorn.word);
    $(".js-info-clothe").html(myUnicorn.clothe);
    // console.log(data);
    if (data != "null" && data) {
      $(".js-info-city").html(data.name);
      LBi.weatherInfo.city = data.name;
    }

    LBi.weatherInfo.word = myUnicorn.word;
    LBi.weatherInfo.clothe = myUnicorn.clothe;

    if (temp == "null") {
      $(".unicorn-day-block").show();
      $(".shareCTA").show();
      $(".unicorn-day-gif").hide();
      $(".js-solo-stars").hide();
      $(".js-dynamic").html("Your Unicorn is dressed for the holidays!");
    } else {
      $(".unicorn-day-allow").show();
      $(".shareCTA").show();
      $(".unicorn-day-gif").hide();
      $(".js-solo-stars").hide();
      $(".js-dynamic").html("Your Unicorn is dressed for the holidays!");
    }
    $(".backgroundImage").addClass("reveal");
    $(".backGradient").addClass("reveal");
  };

  const init = function () {
    return getWeather();
  };
  return {
    init: init,
  };
})(jQuery);

// Social Share
LBi.twitterShare = (function ($) {
  const $html = $("html"),
    twitterTrigger = $(".js-twitter-share"),
    shareLink = window.location.href,
    init = function () {
      twitterTrigger.on("click", _triggerShare);
    },
    _triggerShare = function (e) {
      e.preventDefault();
      _openShareDialog(_twitterShareUrl(), 350, 650);
    },
    _twitterShareUrl = function () {
      let customText;
      if (LBi.weatherInfo.city) {
        customText =
          "Since the weather in " +
          LBi.weatherInfo.city +
          " is " +
          LBi.weatherInfo.word +
          " today, my Digitas Unicorn is wearing " +
          LBi.weatherInfo.clothe +
          " Discover your Unicorn's holiday outfit and help those less fortunate stay warm this winter.";
      } else {
        customText =
          "Since it’s the holiday season, my Digitas Unicorn is wearing a festive ensemble that razzles and dazzles." +
          " Discover your Unicorn’s holiday outfit and help those less fortunate stay warm this winter.";
      }

      return (
        "https://twitter.com/share?url=" +
        shareLink +
        "&via=Digitas&related=twitterapi%2Ctwitter&hashtags=HappyHolidays&text=" +
        customText
      );
    },
    _openShareDialog = function (url, winHeight, winWidth) {
      const winTop = window.screen.height / 2 - winHeight / 2,
        winLeft = window.screen.width / 2 - winWidth / 2;

      if ($html.hasClass("touch")) {
        window.open(url, "_blank");
      } else {
        window.open(
          url,
          "sharer",
          "top=" +
            winTop +
            ",left=" +
            winLeft +
            ",toolbar=0,status=0,width=" +
            winWidth +
            ",height=" +
            winHeight
        );
      }
    };

  return {
    init: init,
  };
})(jQuery);

// On dom ready initialize functionality
$(function () {
  LBi.greeting.init();
  LBi.twitterShare.init();
});
